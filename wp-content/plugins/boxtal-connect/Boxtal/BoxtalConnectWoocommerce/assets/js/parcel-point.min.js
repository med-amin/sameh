"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e={};e.parcelPointLinks={trigger:".bw-select-parcel",mapContainer:null,map:null,markers:[],initMap:function(){var e=this,t=document.createElement("div");t.setAttribute("class","bw-close"),t.setAttribute("title",translations.text.closeMap),t.addEventListener("click",function(){e.closeMap()});var n=document.createElement("div");n.setAttribute("id","bw-map-canvas");var a=document.createElement("div");a.setAttribute("id","bw-map-container"),a.appendChild(n);var o=document.createElement("div");o.setAttribute("id","bw-pp-container");var r=document.createElement("div");r.setAttribute("id","bw-map-inner"),r.appendChild(t),r.appendChild(a),r.appendChild(o),e.mapContainer=document.createElement("div"),e.mapContainer.setAttribute("id","bw-map"),e.mapContainer.appendChild(r),document.body.appendChild(e.mapContainer),e.map=new mapboxgl.Map({container:"bw-map-canvas",style:mapUrl,zoom:14,accessToken:"whatever"}),e.map.addControl(new mapboxgl.NavigationControl);var i=document.createElement("img");i.setAttribute("src",mapLogoImageUrl);var c=document.createElement("a");c.setAttribute("href",mapLogoHrefUrl),c.setAttribute("target","_blank"),c.appendChild(i);var s=document.createElement("div");s.setAttribute("id","bw-boxtal-logo"),s.appendChild(c);var l=document.querySelector(".mapboxgl-ctrl-top-left");l&&l.appendChild(s)},init:function(){var e=this;e.on("body","click",e.trigger,function(){e.mapContainer=document.querySelector("#bw-map"),e.mapContainer||e.initMap(),e.openMap(),e.getPoints()}),e.on("body","click",".bw-parcel-point-button",function(){e.selectPoint(this.getAttribute("data-code"),unescape(this.getAttribute("data-name")),this.getAttribute("data-network"),unescape(this.getAttribute("data-street")),unescape(this.getAttribute("data-zipcode")),unescape(this.getAttribute("data-city")),unescape(this.getAttribute("data-country")),unescape(this.getAttribute("data-openinghours"))).then(function(t){e.initSelectedParcelPoint(),document.querySelector(".bw-parcel-name").innerHTML=t,e.closeMap()})["catch"](function(t){e.showError(t)})})},openMap:function(){this.mapContainer.classList.add("bw-modal-show");var e=window.pageYOffset+(window.innerHeight-this.mapContainer.offsetHeight)/2;e<window.pageYOffset&&(e=window.pageYOffset),this.mapContainer.style.top=e+"px",this.map.resize()},closeMap:function(){this.mapContainer.classList.remove("bw-modal-show"),this.clearMarkers()},initSelectedParcelPoint:function(){var e=document.querySelector(".bw-parcel-client");e.innerHTML=translations.text.selectedParcelPoint+" ";var t=document.createElement("span");t.setAttribute("class","bw-parcel-name"),e.appendChild(t)},getPoints:function(){var e=this;e.getParcelPoints().then(function(t){e.addParcelPointMarkers(t.nearbyParcelPoints),e.fillParcelPointPanel(t.nearbyParcelPoints),e.addRecipientMarker(t.searchLocation),e.setMapBounds()})["catch"](function(t){e.showError(t)})},getParcelPoints:function(){var e=this;return new Promise(function(t,n){var a=e.getSelectedCarrier();a||n(translations.error.carrierNotFound);var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState){var e="object"===_typeof(o.response)&&null!==o.response?o.response:JSON.parse(o.response);!1===e.success?n(e.data.message):t(e)}},o.open("POST",ajaxurl),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.responseType="json",o.send("action=bw_get_points&carrier="+encodeURIComponent(a))})},addParcelPointMarkers:function(e){for(var t=0;t<e.length;t++)e[t].index=t,this.addParcelPointMarker(e[t])},fillSpaces:function(e,t){for(;e.length<t;)e+=" ";return e},formatOpeningDays:function(e){for(var t=[],n=this.fillSpaces("",11),a=0;a<e.length;a++){var o=e[a];if(o.weekday){for(var r=o.weekday[0]+" ",i=o.openingPeriods,c=[],s=0;s<i.length;s++){var l=i[s],p=l.openingTime===undefined?"":l.openingTime,d=l.closingTime===undefined?"":l.closingTime;""!==p&&""!==d?c.push(p+"-"+d):c.push(n)}r+=c.join(" "),a%2==1&&(r='<span style="background-color: #d8d8d8;">'+r+"</span>"),t.push(r)}}return'<pre class="bw-parcel-point-schedule">'+t.join("\n")+"</pre>"},generateParcelPointTagData:function(e){return' data-code="'+e.code+'" data-name="'+escape(e.name)+'" data-network="'+e.network+'" data-zipcode="'+escape(e.location.zipCode)+'" data-country="'+escape(e.location.country)+'" data-city="'+escape(e.location.city)+'" data-street="'+escape(e.location.street)+'" data-openinghours="'+escape(JSON.stringify(e.openingDays))+'" '},addParcelPointMarker:function(e){var t="<div class='bw-marker-popup'><b>"+e.parcelPoint.name+'</b><br/><a href="#" class="bw-parcel-point-button" '+this.generateParcelPointTagData(e.parcelPoint)+"><b>"+translations.text.chooseParcelPoint+"</b></a><br/>"+e.parcelPoint.location.street+", "+e.parcelPoint.location.zipCode+" "+e.parcelPoint.location.city+"<br/><b>"+translations.text.openingHours+"</b><br/>";t+=this.formatOpeningDays(e.parcelPoint.openingDays);var n=this.getMarkerHtmlElement(e.index+1),a=new mapboxgl.Popup({offset:25}).setHTML(t),o=new mapboxgl.Marker({element:n,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(e.parcelPoint.location.position.longitude),parseFloat(e.parcelPoint.location.position.latitude))).setPopup(a).addTo(this.map);this.markers.push(o),this.addRightColMarkerEvent(o,e.parcelPoint.code)},addRightColMarkerEvent:function(e,t){this.on("body","click",".bw-show-info-"+t,function(){e.togglePopup()})},formatHours:function(e){var t=e.split(":");return 3===t.length&&(e=t[0]+":"+t[1]),e},addRecipientMarker:function(e){var t=document.createElement("div");t.className="bw-marker-recipient";var n=new mapboxgl.Marker({element:t,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(e.position.longitude),parseFloat(e.position.latitude))).addTo(this.map);this.markers.push(n)},setMapBounds:function(){for(var e=new mapboxgl.LngLatBounds,t=0;t<this.markers.length;t++){var n=this.markers[t];e=e.extend(n.getLngLat())}this.map.fitBounds(e,{padding:30,linear:!0})},fillParcelPointPanel:function(e){var t="";t+="<table><tbody>";for(var n=0;n<e.length;n++){var a=e[n];t+="<tr>",t+="<td>"+this.getMarkerHtmlElement(n+1).outerHTML,t+='<div class="bw-parcel-point-title"><a class="bw-show-info-'+a.parcelPoint.code+'">'+a.parcelPoint.name+"</a></div><br/>",t+=a.parcelPoint.location.street+"<br/>",t+=a.parcelPoint.location.zipCode+" "+a.parcelPoint.location.city+"<br/>",t+='<a class="bw-parcel-point-button" '+this.generateParcelPointTagData(a.parcelPoint)+"><b>"+translations.text.chooseParcelPoint+"</b></a>",t+="</td>",t+="</tr>"}t+="</tbody></table>",document.querySelector("#bw-pp-container").innerHTML=t},getMarkerHtmlElement:function(e){var t=document.createElement("div");return t.className="bw-marker",t.innerHTML=e,t},selectPoint:function(e,t,n,a,o,r,i,c){var s=this;return new Promise(function(l,p){var d=s.getSelectedCarrier();d||p(translations.error.carrierNotFound);var u=new XMLHttpRequest;u.onreadystatechange=function(){if(4===u.readyState){var e="object"===_typeof(u.response)&&null!==u.response?u.response:JSON.parse(u.response);!1===e.success?p(e.data.message):l(t)}},u.open("POST",ajaxurl),u.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),u.responseType="json",u.send("action=bw_set_point&carrier="+encodeURIComponent(d)+"&code="+encodeURIComponent(e)+"&name="+encodeURIComponent(t)+"&address="+encodeURIComponent(a)+"&zipcode="+encodeURIComponent(o)+"&city="+encodeURIComponent(r)+"&country="+encodeURIComponent(i)+"&openingHours="+encodeURIComponent(c)+"&network="+encodeURIComponent(n))})},clearMarkers:function(){for(var e=0;e<this.markers.length;e++)this.markers[e].remove();this.markers=[]},getSelectedCarrier:function(){var e=void 0,t=document.querySelector('input[type="hidden"].shipping_method');t?e=t.getAttribute("value"):e=document.querySelector("input.shipping_method:checked").getAttribute("value");return e},showError:function(e){this.closeMap(),alert(e)},on:function(e,t,n,a){var o=document.querySelector(e);o.addEventListener(t,function(e){for(var t=o.querySelectorAll(n),r=e.target,i=0,c=t.length;i<c;i++)for(var s=r,l=t[i];s&&s!==o;){if(s===l)return a.call(l,e);s=s.parentNode}})}},document.addEventListener("DOMContentLoaded",function(){e.parcelPointLinks.init()})}();